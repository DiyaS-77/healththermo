
def _setup_bluez_device_watch(self):
    """Subscribe to BlueZ Device1 property changes and track LE GATT readiness."""
    try:
        self._bus = dbus.SystemBus()
        # subscribe to PropertiesChanged for all objects; we'll filter in handler
        self._bus.add_signal_receiver(
            handler_function=self._on_bluez_properties_changed,
            signal_name="PropertiesChanged",
            dbus_interface="org.freedesktop.DBus.Properties",
            path_keyword="path"
        )
    except Exception as e:
        self.log.info(f"Failed to attach BlueZ watchers: {e}")

def _on_bluez_properties_changed(self, interface, changed, invalidated, path):
    """React to org.bluez.Device1 changes: enable GATT only when LE GATT is resolved."""
    if interface != "org.bluez.Device1":
        return

    # We care about Connected and GattServicesResolved
    connected = changed.get("Connected")
    gatt_ok   = changed.get("GattServicesResolved")

    # If props not in 'changed', query current values to avoid race
    try:
        dev_obj = self._bus.get_object("org.bluez", path)
        dev_props = dbus.Interface(dev_obj, "org.freedesktop.DBus.Properties")
        if connected is None:
            connected = bool(dev_props.Get("org.bluez.Device1", "Connected"))
        if gatt_ok is None:
            gatt_ok = bool(dev_props.Get("org.bluez.Device1", "GattServicesResolved"))
    except Exception as e:
        self.log.info(f"BlueZ Get(Device1) failed for {path}: {e}")
        return

    # Update flag: we consider LE GATT ready only when both are True
    prev = self.le_connected
    self.le_connected = bool(connected and gatt_ok)

    if self.le_connected != prev:
        state = "ready" if self.le_connected else "not ready"
        self.log.info(f"[LE GATT] Device {path} is {        self.log.info(f"[LE GATT] Device {path} is {state}")






def _refresh_gatt_entry_state(self):
    """Enable GATT button only when advertising is active AND an LE GATT peer is connected."""
    enable = bool(self.adv_active and self.le_connected)
    self.gatt_button.setEnabled(enable)

self.gatt_button = QPushButton("GATT")
...
self.gatt_button.clicked.connect(self.open_gatt_dialog)
self.gatt_button.setEnabled(False)  # <---self.gatt_button.setEnabled(False)  # <--- disable at launch




self.bluetooth__device__manager.start_advertising(uuid)
self.advself.adv_active = True
self._refresh_gatt_entry_state()




# inside __init__ after other fields
self.adv_active = False
self.le_connected = False

# set up BlueZ property change subscription to track LE connections
self._setup_bluez_device_watch()
